name: Deploy Microservices

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy Workers & Frontend
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Global Wrangler
        run: npm install -g wrangler

      - name: Install Dependencies
        run: |
          npm install
          cd api && npm install
          cd ../api/processor && npm install
          cd ../../api/viewer && npm install
          cd ../../ui && npm install

      # --- Step 1: D1 Migrations ---
      - name: Apply D1 Migrations
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: 'api'
          command: d1 migrations apply DB --remote

      # --- Step 2: Deploy Scanner (Worker A) ---
      - name: Deploy Scanner (Master Node)
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: 'api'
          secrets: |
            TELEGRAM_API_ID
            TELEGRAM_API_HASH
            ACCESS_KEY
            R2_PUBLIC_URL
        env:
          TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
          TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
          ACCESS_KEY: ${{ secrets.ACCESS_KEY }}
          R2_PUBLIC_URL: ${{ secrets.R2_PUBLIC_URL }}

      # --- Step 3: Deploy Processor (Worker B) ---
      - name: Deploy Processor (Downloader)
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: 'api/processor'

      # --- Step 4: Deploy Viewer (Worker C) ---
      - name: Deploy Viewer (Read-Only API)
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: 'api/viewer'

      # --- Step 5: Configure & Deploy Frontend ---
      - name: Generate Frontend Config
        env:
          SUBDOMAIN: ${{ secrets.CLOUDFLARE_SUBDOMAIN }}
        run: |
          echo "Genering API URLs for subdomain: $SUBDOMAIN"
          
          # Construct URLs
          SCANNER_URL="https://telegram-archiver-api.$SUBDOMAIN.workers.dev"
          PROCESSOR_URL="https://telegram-processor.$SUBDOMAIN.workers.dev"
          VIEWER_URL="https://telegram-viewer.$SUBDOMAIN.workers.dev"
          
          # Overwrite api.js
          cat > ui/src/utils/api.js <<EOL
          // Auto-generated by GitHub Actions
          export const SCANNER_URL = "$SCANNER_URL";
          export const PROCESSOR_URL = "$PROCESSOR_URL";
          export const VIEWER_URL = "$VIEWER_URL";
          EOL
          
          echo "Configuration generated:"
          cat ui/src/utils/api.js

      - name: Build Frontend
        working-directory: 'ui'
        run: npm run build

      - name: Deploy Frontend to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: 'ui'
          command: pages deploy dist --project-name telegram-archiver-ui