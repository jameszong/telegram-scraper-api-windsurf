name: Deploy Microservices

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy Workers & Frontend
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: |
          npm install
          cd api && npm install
          cd processor && npm install
          cd ../viewer && npm install
          cd ../../ui && npm install

      - name: Apply D1 Migrations
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: 'api'
          command: d1 migrations apply DB --remote

      - name: Deploy Scanner (Master)
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: 'api'
          secrets: |
            TELEGRAM_API_ID
            TELEGRAM_API_HASH
            ACCESS_KEY
            R2_PUBLIC_URL
            INTERNAL_SERVICE_KEY
        env:
          TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
          TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
          ACCESS_KEY: ${{ secrets.ACCESS_KEY }}
          R2_PUBLIC_URL: ${{ secrets.R2_PUBLIC_URL }}
          INTERNAL_SERVICE_KEY: ${{ secrets.INTERNAL_SERVICE_KEY }}

      - name: Deploy Processor
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: 'api/processor'
          secrets: |
            ACCESS_KEY
            INTERNAL_SERVICE_KEY
        env:
          ACCESS_KEY: ${{ secrets.ACCESS_KEY }}
          INTERNAL_SERVICE_KEY: ${{ secrets.INTERNAL_SERVICE_KEY }}

      - name: Deploy Viewer
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: 'api/viewer'
          secrets: |
            ACCESS_KEY
            INTERNAL_SERVICE_KEY
        env:
          ACCESS_KEY: ${{ secrets.ACCESS_KEY }}
          INTERNAL_SERVICE_KEY: ${{ secrets.INTERNAL_SERVICE_KEY }}

      - name: Generate Frontend Config
        env:
          SUBDOMAIN: ${{ secrets.CLOUDFLARE_SUBDOMAIN }}
          INTERNAL_SERVICE_KEY: ${{ secrets.INTERNAL_SERVICE_KEY }}
        run: |
          SCANNER_URL="https://telegram-archiver-api.$SUBDOMAIN.workers.dev"
          PROCESSOR_URL="https://telegram-processor.$SUBDOMAIN.workers.dev"
          VIEWER_URL="https://telegram-viewer.$SUBDOMAIN.workers.dev"
          cat > ui/src/utils/api.js <<EOF
          // Auto-generated by GitHub Actions
          const SCANNER_URL = "$SCANNER_URL";
          const PROCESSOR_URL = "$PROCESSOR_URL";
          const VIEWER_URL = "$VIEWER_URL";
          const API_BASE = SCANNER_URL;

          export const createAuthenticatedFetch = () => {
            return async (url, options = {}) => {
              const accessKey = localStorage.getItem('access-key-storage');
              const parsedAccessKey = accessKey ? JSON.parse(accessKey).state?.accessKey : null;
              
              const headers = {
                'Content-Type': 'application/json',
                ...options.headers,
              };
              
              if (parsedAccessKey) {
                headers['X-Access-Key'] = parsedAccessKey;
              }
              
              return fetch(url, {
                ...options,
                headers,
              });
            };
          };

          export const createInternalFetch = () => {
            return async (url, options = {}) => {
              const headers = {
                'Content-Type': 'application/json',
                'X-Internal-Key': '$INTERNAL_SERVICE_KEY',
                ...options.headers,
              };
              
              return fetch(url, {
                ...options,
                headers,
              });
            };
          };

          export const authenticatedFetch = createAuthenticatedFetch();
          export const internalFetch = createInternalFetch();
          export { API_BASE, SCANNER_URL, PROCESSOR_URL, VIEWER_URL };
          EOF

      - name: Build Frontend
        working-directory: 'ui'
        run: npm run build

      - name: Deploy Frontend
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: 'ui'
          command: pages deploy dist --project-name telegram-archiver-ui