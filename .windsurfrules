@.windsurfrules

**Update Project Rules to v4.0 (Microservices & Paid Plan)**

**Context:**
The project architecture has fundamentally changed. We are now using Microservices, a Shared D1 Database for config, and Cloudflare Workers Paid Plan.
Old rules about "10ms CPU limit" and "Artificial Delays" are obsolete.

**Action:**
COMPLETELY OVERWRITE `.windsurfrules` with the following content:

# Windsurf Project Rules & Standards (v4.0) - Microservices & Paid Plan

## 1. Architecture: Microservices on Cloudflare üèóÔ∏è
- **Structure**: Three distinct Workers sharing resources.
  1.  **Scanner (`api/`)**: Master Node. Handles Phase A (Sync), Auth, and **Config Seeding** (Env Vars -> D1).
  2.  **Processor (`api/processor/`)**: Media Downloader. Handles Phase B. Reads credentials from D1.
  3.  **Viewer (`api/viewer/`)**: Read-Only API. Serves UI requests. No Telegram connection.
- **Shared Resources**:
  - **D1 Database**: All workers bind to the SAME `database_id`.
  - **R2 Bucket**: All workers bind to the SAME `bucket_name`.
  - **Config Table**: `app_config` table in D1 is the Source of Truth for Secrets (Session/Access Keys).

## 2. Environment: Paid Plan (Unbound) üöÄ
- **Constraints**: 
  - CPU: **30s** (Unbound).
  - Memory: **128MB**.
- **Performance Strategy**:
  - **NO Artificial Delays**: Remove `setTimeout` sleeps. Run as fast as GramJS allows.
  - **Batching**: Use larger batch sizes (e.g., 50-100 messages).
  - **Timeouts**: Set fetch timeouts to **60s** for large media.

## 3. Telegram & Media Strategy üì∏
- **Phase A (Scanner)**:
  - Sync Metadata only. Insert to DB with `media_status='pending'`.
  - **NEVER** download media in Phase A.
- **Phase B (Processor)**:
  - **Filter**: **PHOTOS ONLY**. Explicitly skip Videos/Documents.
  - **Size Limit**: **20MB** (High-Res Photos allowed).
  - **Auth**: Must fetch `TELEGRAM_SESSION` and `ACCESS_KEY` from D1 `app_config`, NOT `c.env`.
  - **Concurrency**: Sequential processing (due to GramJS session lock), but zero wait time between items.

## 4. Coding Standards üõ°Ô∏è
- **BigInt Safety**:
  - Telegram IDs are `BigInt`. Always use `toBigInt()` wrapper.
  - **BANNED**: `Math.min/max` on IDs.
  - **JSON**: Polyfill must be present at entry points.
- **React/Zustand**:
  - **No Patching**: When modifying Stores (`channelStore`, `messageStore`), ask for **Complete Overwrite**.
  - **Imports**: Strict check on `export default` vs `export const`.

## 5. Deployment & Ops ‚öôÔ∏è
- **Deployment**: ALWAYS use `./deploy_all.sh`.
  - Never run `wrangler deploy` manually for individual workers unless debugging.
  - Script handles D1 migrations and UI URL injection.
- **Observability**:
  - Logs enabled in `wrangler.toml` for all workers.
  - Head sampling rate: 1.
