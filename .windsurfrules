# Windsurf Project Rules & Standards (v3.0) - The Async Architecture Update

## 1. Core Philosophy: Decoupled & Async üèóÔ∏è
- **Environment**: Cloudflare Workers (Free Tier Constraints: 10ms CPU / 30s Wall-time).
- **Architecture**: **Split-Phase Processing**.
  - **Phase A (Scanner)**: Text-only, high throughput, DB inserts only. **NO Downloads**.
  - **Phase B (Processor)**: Media-heavy, single-item processing, R2 uploads.
- **Goal**: Zero 503 errors via aggressive load shedding.

## 2. Type Safety: The "BigInt" Iron Law üõ°Ô∏è
**Context**: Telegram IDs (64-bit) crash JS Numbers (53-bit).
- **RULE 1: Helper Only**: Use `toBigInt(val)` wrapper. Never `BigInt()` directly.
- **RULE 2: No Math Functions**: ‚õî `Math.min/max` are BANNED for IDs. Use `if (a < b)`.
- **RULE 3: Strict Suffix**: Comparisons must use `n` suffix (e.g., `id > 0n`).
- **RULE 4: JSON Polyfill**: Must exist at entry point to prevent serialization crashes.

## 3. Telegram Sync Strategy (Reverse: False) üîÑ
- **Direction**: **Newest -> Oldest**. Fetch from Top, walk backwards.
- **Pagination**: `client.iterMessages({ reverse: false, offsetId: ... })`.
- **Batch Sizes**:
  - **Phase A (Text)**: Limit **50**. (Fast metadata indexing).
  - **Phase B (Media)**: Limit **1** (or small queue). (Heavy lifting).

## 4. Media Handling: The "Split" Protocol ‚ö°
**Context**: Downloading media in Phase A causes timeouts.
- **Protocol A (Detection)**:
  - In `/sync`: Check `if (msg.media)`.
  - Action: Mark `media_status = 'pending'`, save `media_type`.
  - **CRITICAL**: Do NOT call `downloadMedia`. Do NOT assume "no download = no media".
- **Protocol B (Upload)**:
  - In `/process-media`: Query `WHERE media_status = 'pending'`.
  - Validation: Must check `buffer && buffer.length > 0` before R2 upload.
  - Commit: Update DB to `completed` ONLY after successful R2 PUT.
- **Delivery**:
  - Worker returns **Public URLs** (`${R2_PUBLIC_URL}/${key}`), NEVER binary blobs.

## 5. Backpressure & Stability üìâ
**Context**: Avoiding Rate Limits and CPU Exhaustion.
- **Dynamic Cooldown**: API must return `suggestedCooldown`.
  - **Text Mode**: ~200ms (Fast).
  - **Media Mode**: ~1500ms+ (Slow).
- **Frontend Logic**:
  - Must respect `suggestedCooldown`.
  - Must render `media_status='pending'` as a placeholder ("Queued").
  - Must update UI state incrementally (don't wait for full batch).

## 6. Database Standards (D1)
- **Schema**:
  - `id` (BigInt/String), `media_status` (Text), `media_key` (Text/Null).
- **Operations**:
  - Reads: Handle `null` results gracefully.
  - Writes: `INSERT OR REPLACE`.
  - **Wait**: Always `await` DB calls.

## 7. Logging & Debugging
- **Format**: `[Phase A/B] - Action - Details`.
- **Constraint**: Do NOT log every message ID in loops (Console Spam). Log batch summaries.
- **BigInt**: `.toString()` before logging.